{
  "version": 3,
  "sources": ["../../../src/utils/isomorphic/utilityScriptSerializers.ts"],
  "sourcesContent": ["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\ntype TypedArrayKind = 'i8' | 'ui8' | 'ui8c' | 'i16' | 'ui16' | 'i32' | 'ui32' | 'f32' | 'f64' | 'bi64' | 'bui64';\n\nexport type SerializedValue =\n    undefined | boolean | number | string |\n    { v: 'null' | 'undefined' | 'NaN' | 'Infinity' | '-Infinity' | '-0' } |\n    { d: string } |\n    { u: string } |\n    { bi: string } |\n    { e: { n: string, m: string, s: string } } |\n    { r: { p: string, f: string } } |\n    { a: SerializedValue[], id: number } |\n    { o: { k: string, v: SerializedValue }[], id: number } |\n    { ref: number } |\n    { h: number } |\n    { ta: { b: string, k: TypedArrayKind } };\n\ntype HandleOrValue = { h: number } | { fallThrough: any };\n\ntype VisitorInfo = {\n  visited: Map<object, number>;\n  lastId: number;\n};\n\nfunction isRegExp(obj: any): obj is RegExp {\n  try {\n    return obj instanceof RegExp || Object.prototype.toString.call(obj) === '[object RegExp]';\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction isDate(obj: any): obj is Date {\n  try {\n    // eslint-disable-next-line no-restricted-globals\n    return obj instanceof Date || Object.prototype.toString.call(obj) === '[object Date]';\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction isURL(obj: any): obj is URL {\n  try {\n    return obj instanceof URL || Object.prototype.toString.call(obj) === '[object URL]';\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction isError(obj: any): obj is Error {\n  try {\n    return obj instanceof Error || (obj && Object.getPrototypeOf(obj)?.name === 'Error');\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction isTypedArray(obj: any, constructor: Function): boolean {\n  try {\n    return obj instanceof constructor || Object.prototype.toString.call(obj) === `[object ${constructor.name}]`;\n  } catch (error) {\n    return false;\n  }\n}\n\nconst typedArrayConstructors: Record<TypedArrayKind, Function> = {\n  i8: Int8Array,\n  ui8: Uint8Array,\n  ui8c: Uint8ClampedArray,\n  i16: Int16Array,\n  ui16: Uint16Array,\n  i32: Int32Array,\n  ui32: Uint32Array,\n  // TODO: add Float16Array once it's in baseline\n  f32: Float32Array,\n  f64: Float64Array,\n  bi64: BigInt64Array,\n  bui64: BigUint64Array,\n};\n\nfunction typedArrayToBase64(array: any) {\n  /**\n   * Firefox does not support iterating over typed arrays, so we use `.toBase64`.\n   * Error: 'Accessing TypedArray data over Xrays is slow, and forbidden in order to encourage performant code. To copy TypedArrays across origin boundaries, consider using Components.utils.cloneInto().'\n   */\n  if ('toBase64' in array)\n    return array.toBase64();\n  const binary = Array.from(new Uint8Array(array.buffer, array.byteOffset, array.byteLength)).map(b => String.fromCharCode(b)).join('');\n  return btoa(binary);\n}\n\nfunction base64ToTypedArray(base64: string, TypedArrayConstructor: any) {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++)\n    bytes[i] = binary.charCodeAt(i);\n  return new TypedArrayConstructor(bytes.buffer);\n}\n\nexport function parseEvaluationResultValue(value: SerializedValue, handles: any[] = [], refs: Map<number, object> = new Map()): any {\n  if (Object.is(value, undefined))\n    return undefined;\n  if (typeof value === 'object' && value) {\n    if ('ref' in value)\n      return refs.get(value.ref);\n    if ('v' in value) {\n      if (value.v === 'undefined')\n        return undefined;\n      if (value.v === 'null')\n        return null;\n      if (value.v === 'NaN')\n        return NaN;\n      if (value.v === 'Infinity')\n        return Infinity;\n      if (value.v === '-Infinity')\n        return -Infinity;\n      if (value.v === '-0')\n        return -0;\n      return undefined;\n    }\n    if ('d' in value) {\n      // eslint-disable-next-line no-restricted-globals\n      return new Date(value.d);\n    }\n    if ('u' in value)\n      return new URL(value.u);\n    if ('bi' in value)\n      return BigInt(value.bi);\n    if ('e' in value) {\n      const error = new Error(value.e.m);\n      error.name = value.e.n;\n      error.stack = value.e.s;\n      return error;\n    }\n    if ('r' in value)\n      return new RegExp(value.r.p, value.r.f);\n    if ('a' in value) {\n      const result: any[] = [];\n      refs.set(value.id, result);\n      for (const a of value.a)\n        result.push(parseEvaluationResultValue(a, handles, refs));\n      return result;\n    }\n    if ('o' in value) {\n      const result: any = {};\n      refs.set(value.id, result);\n      for (const { k, v } of value.o) {\n        if (k === '__proto__')\n          continue;\n        result[k] = parseEvaluationResultValue(v, handles, refs);\n      }\n      return result;\n    }\n    if ('h' in value)\n      return handles[value.h];\n    if ('ta' in value)\n      return base64ToTypedArray(value.ta.b, typedArrayConstructors[value.ta.k]);\n  }\n  return value;\n}\n\nexport function serializeAsCallArgument(value: any, handleSerializer: (value: any) => HandleOrValue): SerializedValue {\n  return serialize(value, handleSerializer, { visited: new Map(), lastId: 0 });\n}\n\nfunction serialize(value: any, handleSerializer: (value: any) => HandleOrValue, visitorInfo: VisitorInfo): SerializedValue {\n  if (value && typeof value === 'object') {\n    // eslint-disable-next-line no-restricted-globals\n    if (typeof globalThis.Window === 'function' && value instanceof globalThis.Window)\n      return 'ref: <Window>';\n    // eslint-disable-next-line no-restricted-globals\n    if (typeof globalThis.Document === 'function' && value instanceof globalThis.Document)\n      return 'ref: <Document>';\n    // eslint-disable-next-line no-restricted-globals\n    if (typeof globalThis.Node === 'function' && value instanceof globalThis.Node)\n      return 'ref: <Node>';\n  }\n  return innerSerialize(value, handleSerializer, visitorInfo);\n}\n\nfunction innerSerialize(value: any, handleSerializer: (value: any) => HandleOrValue, visitorInfo: VisitorInfo): SerializedValue {\n  const result = handleSerializer(value);\n  if ('fallThrough' in result)\n    value = result.fallThrough;\n  else\n    return result;\n\n  if (typeof value === 'symbol')\n    return { v: 'undefined' };\n  if (Object.is(value, undefined))\n    return { v: 'undefined' };\n  if (Object.is(value, null))\n    return { v: 'null' };\n  if (Object.is(value, NaN))\n    return { v: 'NaN' };\n  if (Object.is(value, Infinity))\n    return { v: 'Infinity' };\n  if (Object.is(value, -Infinity))\n    return { v: '-Infinity' };\n  if (Object.is(value, -0))\n    return { v: '-0' };\n\n  if (typeof value === 'boolean')\n    return value;\n  if (typeof value === 'number')\n    return value;\n  if (typeof value === 'string')\n    return value;\n  if (typeof value === 'bigint')\n    return { bi: value.toString() };\n\n  if (isError(value)) {\n    let stack;\n    if (value.stack?.startsWith(value.name + ': ' + value.message)) {\n      // v8\n      stack = value.stack;\n    } else {\n      stack = `${value.name}: ${value.message}\\n${value.stack}`;\n    }\n    return { e: { n: value.name, m: value.message, s: stack } };\n  }\n  if (isDate(value))\n    return { d: value.toJSON() };\n  if (isURL(value))\n    return { u: value.toJSON() };\n  if (isRegExp(value))\n    return { r: { p: value.source, f: value.flags } };\n  for (const [k, ctor] of Object.entries(typedArrayConstructors) as [TypedArrayKind, Function][]) {\n    if (isTypedArray(value, ctor))\n      return { ta: { b: typedArrayToBase64(value), k } };\n  }\n\n  const id = visitorInfo.visited.get(value);\n  if (id)\n    return { ref: id };\n\n  if (Array.isArray(value)) {\n    const a = [];\n    const id = ++visitorInfo.lastId;\n    visitorInfo.visited.set(value, id);\n    for (let i = 0; i < value.length; ++i)\n      a.push(serialize(value[i], handleSerializer, visitorInfo));\n    return { a, id };\n  }\n\n  if (typeof value === 'object') {\n    const o: { k: string, v: SerializedValue }[] = [];\n    const id = ++visitorInfo.lastId;\n    visitorInfo.visited.set(value, id);\n    for (const name of Object.keys(value)) {\n      let item;\n      try {\n        item = value[name];\n      } catch (e) {\n        continue;  // native bindings will throw sometimes\n      }\n      if (name === 'toJSON' && typeof item === 'function')\n        o.push({ k: name, v: { o: [], id: 0 } });\n      else\n        o.push({ k: name, v: serialize(item, handleSerializer, visitorInfo) });\n    }\n\n    let jsonWrapper;\n    try {\n      // If Object.keys().length === 0 we fall back to toJSON if it exists\n      if (o.length === 0 && value.toJSON && typeof value.toJSON === 'function')\n        jsonWrapper = { value: value.toJSON() };\n    } catch (e) {\n    }\n    if (jsonWrapper)\n      return innerSerialize(jsonWrapper.value, handleSerializer, visitorInfo);\n\n    return { o, id };\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAuCA,SAAS,SAAS,KAAyB;AACzC,MAAI;AACF,WAAO,eAAe,UAAU,OAAO,UAAU,SAAS,KAAK,GAAG,MAAM;AAAA,EAC1E,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAEA,SAAS,OAAO,KAAuB;AACrC,MAAI;AAEF,WAAO,eAAe,QAAQ,OAAO,UAAU,SAAS,KAAK,GAAG,MAAM;AAAA,EACxE,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAEA,SAAS,MAAM,KAAsB;AACnC,MAAI;AACF,WAAO,eAAe,OAAO,OAAO,UAAU,SAAS,KAAK,GAAG,MAAM;AAAA,EACvE,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAEA,SAAS,QAAQ,KAAwB;AACvC,MAAI;AACF,WAAO,eAAe,SAAU,OAAO,OAAO,eAAe,GAAG,GAAG,SAAS;AAAA,EAC9E,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAEA,SAAS,aAAa,KAAU,aAAgC;AAC9D,MAAI;AACF,WAAO,eAAe,eAAe,OAAO,UAAU,SAAS,KAAK,GAAG,MAAM,WAAW,YAAY,IAAI;AAAA,EAC1G,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAEA,MAAM,yBAA2D;AAAA,EAC/D,IAAI;AAAA,EACJ,KAAK;AAAA,EACL,MAAM;AAAA,EACN,KAAK;AAAA,EACL,MAAM;AAAA,EACN,KAAK;AAAA,EACL,MAAM;AAAA;AAAA,EAEN,KAAK;AAAA,EACL,KAAK;AAAA,EACL,MAAM;AAAA,EACN,OAAO;AACT;AAEA,SAAS,mBAAmB,OAAY;AAKtC,MAAI,cAAc;AAChB,WAAO,MAAM,SAAS;AACxB,QAAM,SAAS,MAAM,KAAK,IAAI,WAAW,MAAM,QAAQ,MAAM,YAAY,MAAM,UAAU,CAAC,EAAE,IAAI,OAAK,OAAO,aAAa,CAAC,CAAC,EAAE,KAAK,EAAE;AACpI,SAAO,KAAK,MAAM;AACpB;AAEA,SAAS,mBAAmB,QAAgB,uBAA4B;AACtE,QAAM,SAAS,KAAK,MAAM;AAC1B,QAAM,QAAQ,IAAI,WAAW,OAAO,MAAM;AAC1C,WAAS,IAAI,GAAG,IAAI,OAAO,QAAQ;AACjC,UAAM,CAAC,IAAI,OAAO,WAAW,CAAC;AAChC,SAAO,IAAI,sBAAsB,MAAM,MAAM;AAC/C;AAEO,SAAS,2BAA2B,OAAwB,UAAiB,CAAC,GAAG,OAA4B,oBAAI,IAAI,GAAQ;AAClI,MAAI,OAAO,GAAG,OAAO,MAAS;AAC5B,WAAO;AACT,MAAI,OAAO,UAAU,YAAY,OAAO;AACtC,QAAI,SAAS;AACX,aAAO,KAAK,IAAI,MAAM,GAAG;AAC3B,QAAI,OAAO,OAAO;AAChB,UAAI,MAAM,MAAM;AACd,eAAO;AACT,UAAI,MAAM,MAAM;AACd,eAAO;AACT,UAAI,MAAM,MAAM;AACd,eAAO;AACT,UAAI,MAAM,MAAM;AACd,eAAO;AACT,UAAI,MAAM,MAAM;AACd,eAAO;AACT,UAAI,MAAM,MAAM;AACd,eAAO;AACT,aAAO;AAAA,IACT;AACA,QAAI,OAAO,OAAO;AAEhB,aAAO,IAAI,KAAK,MAAM,CAAC;AAAA,IACzB;AACA,QAAI,OAAO;AACT,aAAO,IAAI,IAAI,MAAM,CAAC;AACxB,QAAI,QAAQ;AACV,aAAO,OAAO,MAAM,EAAE;AACxB,QAAI,OAAO,OAAO;AAChB,YAAM,QAAQ,IAAI,MAAM,MAAM,EAAE,CAAC;AACjC,YAAM,OAAO,MAAM,EAAE;AACrB,YAAM,QAAQ,MAAM,EAAE;AACtB,aAAO;AAAA,IACT;AACA,QAAI,OAAO;AACT,aAAO,IAAI,OAAO,MAAM,EAAE,GAAG,MAAM,EAAE,CAAC;AACxC,QAAI,OAAO,OAAO;AAChB,YAAM,SAAgB,CAAC;AACvB,WAAK,IAAI,MAAM,IAAI,MAAM;AACzB,iBAAW,KAAK,MAAM;AACpB,eAAO,KAAK,2BAA2B,GAAG,SAAS,IAAI,CAAC;AAC1D,aAAO;AAAA,IACT;AACA,QAAI,OAAO,OAAO;AAChB,YAAM,SAAc,CAAC;AACrB,WAAK,IAAI,MAAM,IAAI,MAAM;AACzB,iBAAW,EAAE,GAAG,EAAE,KAAK,MAAM,GAAG;AAC9B,YAAI,MAAM;AACR;AACF,eAAO,CAAC,IAAI,2BAA2B,GAAG,SAAS,IAAI;AAAA,MACzD;AACA,aAAO;AAAA,IACT;AACA,QAAI,OAAO;AACT,aAAO,QAAQ,MAAM,CAAC;AACxB,QAAI,QAAQ;AACV,aAAO,mBAAmB,MAAM,GAAG,GAAG,uBAAuB,MAAM,GAAG,CAAC,CAAC;AAAA,EAC5E;AACA,SAAO;AACT;AAEO,SAAS,wBAAwB,OAAY,kBAAkE;AACpH,SAAO,UAAU,OAAO,kBAAkB,EAAE,SAAS,oBAAI,IAAI,GAAG,QAAQ,EAAE,CAAC;AAC7E;AAEA,SAAS,UAAU,OAAY,kBAAiD,aAA2C;AACzH,MAAI,SAAS,OAAO,UAAU,UAAU;AAEtC,QAAI,OAAO,WAAW,WAAW,cAAc,iBAAiB,WAAW;AACzE,aAAO;AAET,QAAI,OAAO,WAAW,aAAa,cAAc,iBAAiB,WAAW;AAC3E,aAAO;AAET,QAAI,OAAO,WAAW,SAAS,cAAc,iBAAiB,WAAW;AACvE,aAAO;AAAA,EACX;AACA,SAAO,eAAe,OAAO,kBAAkB,WAAW;AAC5D;AAEA,SAAS,eAAe,OAAY,kBAAiD,aAA2C;AAC9H,QAAM,SAAS,iBAAiB,KAAK;AACrC,MAAI,iBAAiB;AACnB,YAAQ,OAAO;AAAA;AAEf,WAAO;AAET,MAAI,OAAO,UAAU;AACnB,WAAO,EAAE,GAAG,YAAY;AAC1B,MAAI,OAAO,GAAG,OAAO,MAAS;AAC5B,WAAO,EAAE,GAAG,YAAY;AAC1B,MAAI,OAAO,GAAG,OAAO,IAAI;AACvB,WAAO,EAAE,GAAG,OAAO;AACrB,MAAI,OAAO,GAAG,OAAO,GAAG;AACtB,WAAO,EAAE,GAAG,MAAM;AACpB,MAAI,OAAO,GAAG,OAAO,QAAQ;AAC3B,WAAO,EAAE,GAAG,WAAW;AACzB,MAAI,OAAO,GAAG,OAAO,SAAS;AAC5B,WAAO,EAAE,GAAG,YAAY;AAC1B,MAAI,OAAO,GAAG,OAAO,EAAE;AACrB,WAAO,EAAE,GAAG,KAAK;AAEnB,MAAI,OAAO,UAAU;AACnB,WAAO;AACT,MAAI,OAAO,UAAU;AACnB,WAAO;AACT,MAAI,OAAO,UAAU;AACnB,WAAO;AACT,MAAI,OAAO,UAAU;AACnB,WAAO,EAAE,IAAI,MAAM,SAAS,EAAE;AAEhC,MAAI,QAAQ,KAAK,GAAG;AAClB,QAAI;AACJ,QAAI,MAAM,OAAO,WAAW,MAAM,OAAO,OAAO,MAAM,OAAO,GAAG;AAE9D,cAAQ,MAAM;AAAA,IAChB,OAAO;AACL,cAAQ,GAAG,MAAM,IAAI,KAAK,MAAM,OAAO;AAAA,EAAK,MAAM,KAAK;AAAA,IACzD;AACA,WAAO,EAAE,GAAG,EAAE,GAAG,MAAM,MAAM,GAAG,MAAM,SAAS,GAAG,MAAM,EAAE;AAAA,EAC5D;AACA,MAAI,OAAO,KAAK;AACd,WAAO,EAAE,GAAG,MAAM,OAAO,EAAE;AAC7B,MAAI,MAAM,KAAK;AACb,WAAO,EAAE,GAAG,MAAM,OAAO,EAAE;AAC7B,MAAI,SAAS,KAAK;AAChB,WAAO,EAAE,GAAG,EAAE,GAAG,MAAM,QAAQ,GAAG,MAAM,MAAM,EAAE;AAClD,aAAW,CAAC,GAAG,IAAI,KAAK,OAAO,QAAQ,sBAAsB,GAAmC;AAC9F,QAAI,aAAa,OAAO,IAAI;AAC1B,aAAO,EAAE,IAAI,EAAE,GAAG,mBAAmB,KAAK,GAAG,EAAE,EAAE;AAAA,EACrD;AAEA,QAAM,KAAK,YAAY,QAAQ,IAAI,KAAK;AACxC,MAAI;AACF,WAAO,EAAE,KAAK,GAAG;AAEnB,MAAI,MAAM,QAAQ,KAAK,GAAG;AACxB,UAAM,IAAI,CAAC;AACX,UAAMA,MAAK,EAAE,YAAY;AACzB,gBAAY,QAAQ,IAAI,OAAOA,GAAE;AACjC,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,EAAE;AAClC,QAAE,KAAK,UAAU,MAAM,CAAC,GAAG,kBAAkB,WAAW,CAAC;AAC3D,WAAO,EAAE,GAAG,IAAAA,IAAG;AAAA,EACjB;AAEA,MAAI,OAAO,UAAU,UAAU;AAC7B,UAAM,IAAyC,CAAC;AAChD,UAAMA,MAAK,EAAE,YAAY;AACzB,gBAAY,QAAQ,IAAI,OAAOA,GAAE;AACjC,eAAW,QAAQ,OAAO,KAAK,KAAK,GAAG;AACrC,UAAI;AACJ,UAAI;AACF,eAAO,MAAM,IAAI;AAAA,MACnB,SAAS,GAAG;AACV;AAAA,MACF;AACA,UAAI,SAAS,YAAY,OAAO,SAAS;AACvC,UAAE,KAAK,EAAE,GAAG,MAAM,GAAG,EAAE,GAAG,CAAC,GAAG,IAAI,EAAE,EAAE,CAAC;AAAA;AAEvC,UAAE,KAAK,EAAE,GAAG,MAAM,GAAG,UAAU,MAAM,kBAAkB,WAAW,EAAE,CAAC;AAAA,IACzE;AAEA,QAAI;AACJ,QAAI;AAEF,UAAI,EAAE,WAAW,KAAK,MAAM,UAAU,OAAO,MAAM,WAAW;AAC5D,sBAAc,EAAE,OAAO,MAAM,OAAO,EAAE;AAAA,IAC1C,SAAS,GAAG;AAAA,IACZ;AACA,QAAI;AACF,aAAO,eAAe,YAAY,OAAO,kBAAkB,WAAW;AAExE,WAAO,EAAE,GAAG,IAAAA,IAAG;AAAA,EACjB;AACF;",
  "names": ["id"]
}
