{
  "version": 3,
  "sources": ["../../../src/server/webkit/wkExecutionContext.ts"],
  "sourcesContent": ["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as js from '../javascript';\nimport * as dom from '../dom';\nimport { isSessionClosedError } from '../protocolError';\nimport { assert } from '../../utils/isomorphic/assert';\nimport { parseEvaluationResultValue } from '../../utils/isomorphic/utilityScriptSerializers';\n\nimport type { Protocol } from './protocol';\nimport type { WKSession } from './wkConnection';\n\nexport class WKExecutionContext implements js.ExecutionContextDelegate {\n  private readonly _session: WKSession;\n  readonly _contextId: number | undefined;\n\n  constructor(session: WKSession, contextId: number | undefined) {\n    this._session = session;\n    this._contextId = contextId;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: true\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      return response.result.value;\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async rawEvaluateHandle(context: js.ExecutionContext, expression: string): Promise<js.JSHandle> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: false\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      return createHandle(context, response.result);\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], handles: js.JSHandle[]): Promise<any> {\n    try {\n      const response = await this._session.send('Runtime.callFunctionOn', {\n        functionDeclaration: expression,\n        objectId: utilityScript._objectId!,\n        arguments: [\n          { objectId: utilityScript._objectId },\n          ...values.map(value => ({ value })),\n          ...handles.map(handle => ({ objectId: handle._objectId! })),\n        ],\n        returnByValue,\n        emulateUserGesture: true,\n        awaitPromise: true\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      if (returnByValue)\n        return parseEvaluationResultValue(response.result.value);\n      return createHandle(utilityScript._context, response.result);\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async getProperties(object: js.JSHandle): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getProperties', {\n      objectId: object._objectId!,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.properties) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, createHandle(object._context, property.value));\n    }\n    return result;\n  }\n\n  async releaseHandle(handle: js.JSHandle): Promise<void> {\n    if (!handle._objectId)\n      return;\n    await this._session.send('Runtime.releaseObject', { objectId: handle._objectId });\n  }\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const isUnserializable = remoteObject.type === 'number' && ['NaN', '-Infinity', 'Infinity', '-0'].includes(remoteObject.description!);\n  return isUnserializable ? js.parseUnserializableValue(remoteObject.description!) : value;\n}\n\nfunction rewriteError(error: Error): Error {\n  if (error.message.includes('Object has too long reference chain'))\n    throw new Error('Cannot serialize result: object reference chain is too long.');\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    return new Error('Execution context was destroyed, most likely because of a navigation.');\n  return error;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties!)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview)\n    return js.sparseArrayToString(object.preview.properties!);\n  return object.description;\n}\n\nexport function createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n  if (remoteObject.subtype === 'node') {\n    assert(context instanceof dom.FrameExecutionContext);\n    return new dom.ElementHandle(context as dom.FrameExecutionContext, remoteObject.objectId!);\n  }\n  const isPromise = remoteObject.className === 'Promise';\n  return new js.JSHandle(context, isPromise ? 'promise' : remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAiBA,SAAoB;AACpB,UAAqB;AACrB,2BAAqC;AACrC,oBAAuB;AACvB,sCAA2C;AAKpC,MAAM,mBAA0D;AAAA,EAIrE,YAAY,SAAoB,WAA+B;AAC7D,SAAK,WAAW;AAChB,SAAK,aAAa;AAAA,EACpB;AAAA,EAEA,MAAM,gBAAgB,YAAkC;AACtD,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,SAAS,KAAK,oBAAoB;AAAA,QAC5D;AAAA,QACA,WAAW,KAAK;AAAA,QAChB,eAAe;AAAA,MACjB,CAAC;AACD,UAAI,SAAS;AACX,cAAM,IAAI,GAAG,0BAA0B,SAAS,OAAO,WAAW;AACpE,aAAO,SAAS,OAAO;AAAA,IACzB,SAAS,OAAO;AACd,YAAM,aAAa,KAAK;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAM,kBAAkB,SAA8B,YAA0C;AAC9F,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,SAAS,KAAK,oBAAoB;AAAA,QAC5D;AAAA,QACA,WAAW,KAAK;AAAA,QAChB,eAAe;AAAA,MACjB,CAAC;AACD,UAAI,SAAS;AACX,cAAM,IAAI,GAAG,0BAA0B,SAAS,OAAO,WAAW;AACpE,aAAO,aAAa,SAAS,SAAS,MAAM;AAAA,IAC9C,SAAS,OAAO;AACd,YAAM,aAAa,KAAK;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAM,sBAAsB,YAAoB,eAAwB,eAAiC,QAAe,SAAsC;AAC5J,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,SAAS,KAAK,0BAA0B;AAAA,QAClE,qBAAqB;AAAA,QACrB,UAAU,cAAc;AAAA,QACxB,WAAW;AAAA,UACT,EAAE,UAAU,cAAc,UAAU;AAAA,UACpC,GAAG,OAAO,IAAI,YAAU,EAAE,MAAM,EAAE;AAAA,UAClC,GAAG,QAAQ,IAAI,aAAW,EAAE,UAAU,OAAO,UAAW,EAAE;AAAA,QAC5D;AAAA,QACA;AAAA,QACA,oBAAoB;AAAA,QACpB,cAAc;AAAA,MAChB,CAAC;AACD,UAAI,SAAS;AACX,cAAM,IAAI,GAAG,0BAA0B,SAAS,OAAO,WAAW;AACpE,UAAI;AACF,mBAAO,4DAA2B,SAAS,OAAO,KAAK;AACzD,aAAO,aAAa,cAAc,UAAU,SAAS,MAAM;AAAA,IAC7D,SAAS,OAAO;AACd,YAAM,aAAa,KAAK;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAM,cAAc,QAAwD;AAC1E,UAAM,WAAW,MAAM,KAAK,SAAS,KAAK,yBAAyB;AAAA,MACjE,UAAU,OAAO;AAAA,MACjB,eAAe;AAAA,IACjB,CAAC;AACD,UAAM,SAAS,oBAAI,IAAI;AACvB,eAAW,YAAY,SAAS,YAAY;AAC1C,UAAI,CAAC,SAAS,cAAc,CAAC,SAAS;AACpC;AACF,aAAO,IAAI,SAAS,MAAM,aAAa,OAAO,UAAU,SAAS,KAAK,CAAC;AAAA,IACzE;AACA,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,cAAc,QAAoC;AACtD,QAAI,CAAC,OAAO;AACV;AACF,UAAM,KAAK,SAAS,KAAK,yBAAyB,EAAE,UAAU,OAAO,UAAU,CAAC;AAAA,EAClF;AACF;AAEA,SAAS,+BAA+B,cAAkD;AACxF,QAAM,QAAQ,aAAa;AAC3B,QAAM,mBAAmB,aAAa,SAAS,YAAY,CAAC,OAAO,aAAa,YAAY,IAAI,EAAE,SAAS,aAAa,WAAY;AACpI,SAAO,mBAAmB,GAAG,yBAAyB,aAAa,WAAY,IAAI;AACrF;AAEA,SAAS,aAAa,OAAqB;AACzC,MAAI,MAAM,QAAQ,SAAS,qCAAqC;AAC9D,UAAM,IAAI,MAAM,8DAA8D;AAChF,MAAI,CAAC,GAAG,4BAA4B,KAAK,KAAK,KAAC,2CAAqB,KAAK;AACvE,WAAO,IAAI,MAAM,uEAAuE;AAC1F,SAAO;AACT;AAEA,SAAS,cAAc,QAA2D;AAChF,MAAI,OAAO,SAAS;AAClB,WAAO;AACT,MAAI,WAAW;AACb,WAAO,OAAO,OAAO,KAAK;AAE5B,MAAI,OAAO,gBAAgB,YAAY,OAAO,SAAS;AACrD,UAAM,SAAS,CAAC;AAChB,eAAW,EAAE,MAAM,MAAM,KAAK,OAAO,QAAQ;AAC3C,aAAO,KAAK,GAAG,IAAI,KAAK,KAAK,EAAE;AACjC,WAAO,IAAI,OAAO,KAAK,IAAI,CAAC;AAAA,EAC9B;AACA,MAAI,OAAO,YAAY,WAAW,OAAO;AACvC,WAAO,GAAG,oBAAoB,OAAO,QAAQ,UAAW;AAC1D,SAAO,OAAO;AAChB;AAEO,SAAS,aAAa,SAA8B,cAA0D;AACnH,MAAI,aAAa,YAAY,QAAQ;AACnC,8BAAO,mBAAmB,IAAI,qBAAqB;AACnD,WAAO,IAAI,IAAI,cAAc,SAAsC,aAAa,QAAS;AAAA,EAC3F;AACA,QAAM,YAAY,aAAa,cAAc;AAC7C,SAAO,IAAI,GAAG,SAAS,SAAS,YAAY,YAAY,aAAa,WAAW,aAAa,MAAM,cAAc,YAAY,GAAG,aAAa,UAAU,+BAA+B,YAAY,CAAC;AACrM;",
  "names": []
}
