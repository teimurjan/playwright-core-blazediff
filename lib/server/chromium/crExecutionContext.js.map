{
  "version": 3,
  "sources": ["../../../src/server/chromium/crExecutionContext.ts"],
  "sourcesContent": ["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assert } from '../../utils/isomorphic/assert';\nimport { getExceptionMessage, releaseObject } from './crProtocolHelper';\nimport { rewriteErrorMessage } from '../../utils/isomorphic/stackTrace';\nimport { parseEvaluationResultValue } from '../../utils/isomorphic/utilityScriptSerializers';\nimport * as js from '../javascript';\nimport * as dom from '../dom';\nimport { isSessionClosedError } from '../protocolError';\n\nimport type { CRSession } from './crConnection';\nimport type { Protocol } from './protocol';\n\nexport class CRExecutionContext implements js.ExecutionContextDelegate {\n  _client: CRSession;\n  _contextId: number;\n\n  constructor(client: CRSession, contextPayload: Protocol.Runtime.ExecutionContextDescription) {\n    this._client = client;\n    this._contextId = contextPayload.id;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n      returnByValue: true,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return remoteObject.value;\n  }\n\n  async rawEvaluateHandle(context: js.ExecutionContext, expression: string): Promise<js.JSHandle> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return createHandle(context, remoteObject);\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle, values: any[], handles: js.JSHandle[]): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.callFunctionOn', {\n      functionDeclaration: expression,\n      objectId: utilityScript._objectId,\n      arguments: [\n        { objectId: utilityScript._objectId },\n        ...values.map(value => ({ value })),\n        ...handles.map(handle => ({ objectId: handle._objectId! })),\n      ],\n      returnByValue,\n      awaitPromise: true,\n      userGesture: true\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return returnByValue ? parseEvaluationResultValue(remoteObject.value) : createHandle(utilityScript._context, remoteObject);\n  }\n\n  async getProperties(object: js.JSHandle): Promise<Map<string, js.JSHandle>> {\n    const response = await this._client.send('Runtime.getProperties', {\n      objectId: object._objectId!,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.result) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, createHandle(object._context, property.value));\n    }\n    return result;\n  }\n\n  async releaseHandle(handle: js.JSHandle): Promise<void> {\n    if (!handle._objectId)\n      return;\n    await releaseObject(this._client, handle._objectId);\n  }\n}\n\nfunction rewriteError(error: Error): Protocol.Runtime.evaluateReturnValue {\n  if (error.message.includes('Object reference chain is too long'))\n    throw new Error('Cannot serialize result: object reference chain is too long.');\n  if (error.message.includes('Object couldn\\'t be returned by value'))\n    return { result: { type: 'undefined' } };\n\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview)\n    return js.sparseArrayToString(object.preview.properties);\n  return object.description;\n}\n\nexport function createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n  if (remoteObject.subtype === 'node') {\n    assert(context instanceof dom.FrameExecutionContext);\n    return new dom.ElementHandle(context, remoteObject.objectId!);\n  }\n  return new js.JSHandle(context, remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n}\n"],
  "mappings": "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",
  "names": []
}
