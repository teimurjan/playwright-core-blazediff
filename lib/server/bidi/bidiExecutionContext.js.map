{
  "version": 3,
  "sources": ["../../../src/server/bidi/bidiExecutionContext.ts"],
  "sourcesContent": ["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assert } from '../../utils';\nimport { parseEvaluationResultValue } from '../../utils/isomorphic/utilityScriptSerializers';\nimport * as js from '../javascript';\nimport * as dom from '../dom';\nimport { BidiDeserializer } from './third_party/bidiDeserializer';\nimport * as bidi from './third_party/bidiProtocol';\nimport { BidiSerializer } from './third_party/bidiSerializer';\n\nimport type { BidiSession } from './bidiConnection';\n\nexport class BidiExecutionContext implements js.ExecutionContextDelegate {\n  private readonly _session: BidiSession;\n  readonly _target: bidi.Script.Target;\n\n  constructor(session: BidiSession, realmInfo: bidi.Script.RealmInfo) {\n    this._session = session;\n    if (realmInfo.type === 'window') {\n      // Simple realm does not seem to work for Window contexts.\n      this._target = {\n        context: realmInfo.context,\n        sandbox: realmInfo.sandbox,\n      };\n    } else {\n      this._target = {\n        realm: realmInfo.realm\n      };\n    }\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const response = await this._session.send('script.evaluate', {\n      expression,\n      target: this._target,\n      serializationOptions: {\n        maxObjectDepth: 10,\n        maxDomDepth: 10,\n      },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'success')\n      return BidiDeserializer.deserialize(response.result);\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  async rawEvaluateHandle(context: js.ExecutionContext, expression: string): Promise<js.JSHandle> {\n    const response = await this._session.send('script.evaluate', {\n      expression,\n      target: this._target,\n      resultOwnership: bidi.Script.ResultOwnership.Root, // Necessary for the handle to be returned.\n      serializationOptions: { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'success') {\n      if ('handle' in response.result)\n        return createHandle(context, response.result);\n      throw new js.JavaScriptErrorInEvaluate('Cannot get handle: ' + JSON.stringify(response.result));\n    }\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  async evaluateWithArguments(functionDeclaration: string, returnByValue: boolean, utilityScript: js.JSHandle, values: any[], handles: js.JSHandle[]): Promise<any> {\n    const response = await this._session.send('script.callFunction', {\n      functionDeclaration,\n      target: this._target,\n      arguments: [\n        { handle: utilityScript._objectId! },\n        ...values.map(BidiSerializer.serialize),\n        ...handles.map(handle => ({ handle: handle._objectId! })),\n      ],\n      resultOwnership: returnByValue ? undefined : bidi.Script.ResultOwnership.Root, // Necessary for the handle to be returned.\n      serializationOptions: returnByValue ? {} : { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    if (response.type === 'success') {\n      if (returnByValue)\n        return parseEvaluationResultValue(BidiDeserializer.deserialize(response.result));\n      return createHandle(utilityScript._context, response.result);\n    }\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  async getProperties(handle: js.JSHandle): Promise<Map<string, js.JSHandle>> {\n    const names = await handle.evaluate(object => {\n      const names = [];\n      const descriptors = Object.getOwnPropertyDescriptors(object);\n      for (const name in descriptors) {\n        if (descriptors[name]?.enumerable)\n          names.push(name);\n      }\n      return names;\n    });\n    const values = await Promise.all(names.map(name => handle.evaluateHandle((object, name) => object[name], name)));\n    const map = new Map<string, js.JSHandle>();\n    for (let i = 0; i < names.length; i++)\n      map.set(names[i], values[i]);\n    return map;\n  }\n\n  async releaseHandle(handle: js.JSHandle): Promise<void> {\n    if (!handle._objectId)\n      return;\n    await this._session.send('script.disown', {\n      target: this._target,\n      handles: [handle._objectId],\n    });\n  }\n\n\n  async nodeIdForElementHandle(handle: dom.ElementHandle): Promise<bidi.Script.SharedReference> {\n    const shared = await this._remoteValueForReference({ handle: handle._objectId });\n    // TODO: store sharedId in the handle.\n    if (!('sharedId' in shared))\n      throw new Error('Element is not a node');\n    return {\n      sharedId: shared.sharedId!,\n    };\n  }\n\n  async remoteObjectForNodeId(context: dom.FrameExecutionContext, nodeId: bidi.Script.SharedReference): Promise<js.JSHandle> {\n    const result = await this._remoteValueForReference(nodeId, true);\n    if (!('handle' in result))\n      throw new Error('Can\\'t get remote object for nodeId');\n    return createHandle(context, result);\n  }\n\n  async contentFrameIdForFrame(handle: dom.ElementHandle) {\n    const contentWindow = await this._rawCallFunction('e => e.contentWindow', { handle: handle._objectId });\n    if (contentWindow?.type === 'window')\n      return contentWindow.value.context;\n    return null;\n  }\n\n  async frameIdForWindowHandle(handle: js.JSHandle): Promise<string | null> {\n    if (!handle._objectId)\n      throw new Error('JSHandle is not a DOM node handle');\n    const contentWindow = await this._remoteValueForReference({ handle: handle._objectId });\n    if (contentWindow.type === 'window')\n      return contentWindow.value.context;\n    return null;\n  }\n\n  private async _remoteValueForReference(reference: bidi.Script.RemoteReference, createHandle?: boolean) {\n    return await this._rawCallFunction('e => e', reference, createHandle);\n  }\n\n  private async _rawCallFunction(functionDeclaration: string, arg: bidi.Script.LocalValue, createHandle?: boolean): Promise<bidi.Script.RemoteValue> {\n    const response = await this._session.send('script.callFunction', {\n      functionDeclaration,\n      target: this._target,\n      arguments: [arg],\n      // \"Root\" is necessary for the handle to be returned.\n      resultOwnership: createHandle ? bidi.Script.ResultOwnership.Root : bidi.Script.ResultOwnership.None,\n      serializationOptions: { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    if (response.type === 'success')\n      return response.result;\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n}\n\nfunction renderPreview(remoteObject: bidi.Script.RemoteValue): string | undefined {\n  if (remoteObject.type === 'undefined')\n    return 'undefined';\n  if (remoteObject.type === 'null')\n    return 'null';\n  if ('value' in remoteObject)\n    return String(remoteObject.value);\n  return `<${remoteObject.type}>`;\n}\n\nfunction remoteObjectValue(remoteObject: bidi.Script.RemoteValue): any {\n  if (remoteObject.type === 'undefined')\n    return undefined;\n  if (remoteObject.type === 'null')\n    return null;\n  if (remoteObject.type === 'number' && typeof remoteObject.value === 'string')\n    return js.parseUnserializableValue(remoteObject.value);\n  if ('value' in remoteObject)\n    return remoteObject.value;\n  return undefined;\n}\n\nexport function createHandle(context: js.ExecutionContext, remoteObject: bidi.Script.RemoteValue): js.JSHandle {\n  if (remoteObject.type === 'node') {\n    assert(context instanceof dom.FrameExecutionContext);\n    return new dom.ElementHandle(context, remoteObject.handle!);\n  }\n  const objectId = 'handle' in remoteObject ? remoteObject.handle : undefined;\n  return new js.JSHandle(context, remoteObject.type, renderPreview(remoteObject), objectId, remoteObjectValue(remoteObject));\n}\n"],
  "mappings": "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",
  "names": ["names", "name", "createHandle"]
}
