{
  "version": 3,
  "sources": ["../../../src/server/bidi/bidiConnection.ts"],
  "sourcesContent": ["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from 'events';\n\nimport { debugLogger } from '../utils/debugLogger';\nimport { helper } from '../helper';\nimport { ProtocolError } from '../protocolError';\n\nimport type { RecentLogsCollector } from '../utils/debugLogger';\nimport type { ConnectionTransport, ProtocolRequest, ProtocolResponse } from '../transport';\nimport type { ProtocolLogger } from '../types';\nimport type * as bidiCommands from './third_party/bidiCommands';\nimport type * as bidi from './third_party/bidiProtocol';\n\n// BidiPlaywright uses this special id to issue Browser.close command which we\n// should ignore.\nexport const kBrowserCloseMessageId = 0;\n\nexport class BidiConnection {\n  private readonly _transport: ConnectionTransport;\n  private readonly _onDisconnect: () => void;\n  private readonly _protocolLogger: ProtocolLogger;\n  private readonly _browserLogsCollector: RecentLogsCollector;\n  _browserDisconnectedLogs: string | undefined;\n  private _lastId = 0;\n  private _closed = false;\n  readonly browserSession: BidiSession;\n  readonly _browsingContextToSession = new Map<string, BidiSession>();\n\n  constructor(transport: ConnectionTransport, onDisconnect: () => void, protocolLogger: ProtocolLogger, browserLogsCollector: RecentLogsCollector) {\n    this._transport = transport;\n    this._onDisconnect = onDisconnect;\n    this._protocolLogger = protocolLogger;\n    this._browserLogsCollector = browserLogsCollector;\n    this.browserSession = new BidiSession(this, '', (message: any) => {\n      this.rawSend(message);\n    });\n    this._transport.onmessage = this._dispatchMessage.bind(this);\n    // onclose should be set last, since it can be immediately called.\n    this._transport.onclose = this._onClose.bind(this);\n  }\n\n  nextMessageId(): number {\n    return ++this._lastId;\n  }\n\n  rawSend(message: ProtocolRequest) {\n    this._protocolLogger('send', message);\n    this._transport.send(message);\n  }\n\n  private _dispatchMessage(message: ProtocolResponse) {\n    this._protocolLogger('receive', message);\n    const object = message as bidi.Message;\n    // Bidi messages do not have a common session identifier, so we\n    // route them based on BrowsingContext.\n    if (object.type === 'event') {\n      // Route page events to the right session.\n      let context;\n      if ('context' in object.params)\n        context = object.params.context;\n      else if (object.method === 'log.entryAdded' || object.method === 'script.message')\n        context = object.params.source?.context;\n      if (context) {\n        const session = this._browsingContextToSession.get(context);\n        if (session) {\n          session.dispatchMessage(message);\n          return;\n        }\n      }\n    } else if (message.id) {\n      // Find caller session.\n      for (const session of this._browsingContextToSession.values()) {\n        if (session.hasCallback(message.id)) {\n          session.dispatchMessage(message);\n          return;\n        }\n      }\n    }\n    this.browserSession.dispatchMessage(message);\n  }\n\n  _onClose(reason?: string) {\n    this._closed = true;\n    this._transport.onmessage = undefined;\n    this._transport.onclose = undefined;\n    this._browserDisconnectedLogs = helper.formatBrowserLogs(this._browserLogsCollector.recentLogs(), reason);\n    this.browserSession.dispose();\n    this._onDisconnect();\n  }\n\n  isClosed() {\n    return this._closed;\n  }\n\n  close() {\n    if (!this._closed)\n      this._transport.close();\n  }\n\n  createMainFrameBrowsingContextSession(bowsingContextId: bidi.BrowsingContext.BrowsingContext): BidiSession {\n    const result = new BidiSession(this, bowsingContextId, message => this.rawSend(message));\n    this._browsingContextToSession.set(bowsingContextId, result);\n    return result;\n  }\n}\n\ntype BidiEvents = {\n  [K in bidi.Event['method']]: Extract<bidi.Event, {method: K}>;\n};\n\nexport class BidiSession extends EventEmitter {\n  readonly connection: BidiConnection;\n  readonly sessionId: string;\n\n  private _disposed = false;\n  private readonly _rawSend: (message: any) => void;\n  private readonly _callbacks = new Map<number, { resolve: (o: any) => void, reject: (e: ProtocolError) => void, error: ProtocolError }>();\n  private _crashed: boolean = false;\n  private readonly _browsingContexts = new Set<string>();\n\n  override on: <T extends keyof BidiEvents | symbol>(event: T, listener: (payload: T extends symbol ? any : BidiEvents[T extends keyof BidiEvents ? T : never]['params']) => void) => this;\n  override addListener: <T extends keyof BidiEvents | symbol>(event: T, listener: (payload: T extends symbol ? any : BidiEvents[T extends keyof BidiEvents ? T : never]['params']) => void) => this;\n  override off: <T extends keyof BidiEvents | symbol>(event: T, listener: (payload: T extends symbol ? any : BidiEvents[T extends keyof BidiEvents ? T : never]['params']) => void) => this;\n  override removeListener: <T extends keyof BidiEvents | symbol>(event: T, listener: (payload: T extends symbol ? any : BidiEvents[T extends keyof BidiEvents ? T : never]['params']) => void) => this;\n  override once: <T extends keyof BidiEvents | symbol>(event: T, listener: (payload: T extends symbol ? any : BidiEvents[T extends keyof BidiEvents ? T : never]['params']) => void) => this;\n\n  constructor(connection: BidiConnection, sessionId: string, rawSend: (message: any) => void) {\n    super();\n    this.setMaxListeners(0);\n    this.connection = connection;\n    this.sessionId = sessionId;\n    this._rawSend = rawSend;\n\n    this.on = super.on;\n    this.off = super.removeListener;\n    this.addListener = super.addListener;\n    this.removeListener = super.removeListener;\n    this.once = super.once;\n  }\n\n  addFrameBrowsingContext(context: string) {\n    this._browsingContexts.add(context);\n    this.connection._browsingContextToSession.set(context, this);\n  }\n\n  removeFrameBrowsingContext(context: string) {\n    this._browsingContexts.delete(context);\n    this.connection._browsingContextToSession.delete(context);\n  }\n\n  async send<T extends keyof bidiCommands.Commands>(\n    method: T,\n    params?: bidiCommands.Commands[T]['params']\n  ): Promise<bidiCommands.Commands[T]['returnType']> {\n    if (this._crashed || this._disposed || this.connection._browserDisconnectedLogs)\n      throw new ProtocolError(this._crashed ? 'crashed' : 'closed', undefined, this.connection._browserDisconnectedLogs);\n    const id = this.connection.nextMessageId();\n    const messageObj = { id, method, params };\n    this._rawSend(messageObj);\n    return new Promise<bidiCommands.Commands[T]['returnType']>((resolve, reject) => {\n      this._callbacks.set(id, { resolve, reject, error: new ProtocolError('error', method) });\n    });\n  }\n\n  sendMayFail<T extends keyof bidiCommands.Commands>(method: T, params?: bidiCommands.Commands[T]['params']): Promise<bidiCommands.Commands[T]['returnType'] | void> {\n    return this.send(method, params).catch(error => debugLogger.log('error', error));\n  }\n\n  markAsCrashed() {\n    this._crashed = true;\n  }\n\n  isDisposed(): boolean {\n    return this._disposed;\n  }\n\n  dispose() {\n    this._disposed = true;\n    this.connection._browsingContextToSession.delete(this.sessionId);\n    for (const context of this._browsingContexts)\n      this.connection._browsingContextToSession.delete(context);\n    this._browsingContexts.clear();\n    for (const callback of this._callbacks.values()) {\n      callback.error.type = this._crashed ? 'crashed' : 'closed';\n      callback.error.logs = this.connection._browserDisconnectedLogs;\n      callback.reject(callback.error);\n    }\n    this._callbacks.clear();\n  }\n\n  hasCallback(id: number): boolean {\n    return this._callbacks.has(id);\n  }\n\n  dispatchMessage(message: any) {\n    const object = message as bidi.Message;\n    if (object.id === kBrowserCloseMessageId)\n      return;\n    if (object.id && this._callbacks.has(object.id)) {\n      const callback = this._callbacks.get(object.id)!;\n      this._callbacks.delete(object.id);\n      if (object.type === 'error') {\n        callback.error.setMessage(object.error + '\\nMessage: ' + object.message);\n        callback.reject(callback.error);\n      } else if (object.type === 'success') {\n        callback.resolve(object.result);\n      } else {\n        callback.error.setMessage('Internal error, unexpected response type: ' + JSON.stringify(object));\n        callback.reject(callback.error);\n      }\n    } else if (object.id) {\n      // Response might come after session has been disposed and rejected all callbacks.\n    } else {\n      Promise.resolve().then(() => this.emit(object.method, object.params));\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
