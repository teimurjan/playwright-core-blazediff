{
  "version": 3,
  "sources": ["../../../src/server/firefox/ffExecutionContext.ts"],
  "sourcesContent": ["/**\n * Copyright 2019 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assert } from '../../utils/isomorphic/assert';\nimport { rewriteErrorMessage } from '../../utils/isomorphic/stackTrace';\nimport { parseEvaluationResultValue } from '../../utils/isomorphic/utilityScriptSerializers';\nimport * as js from '../javascript';\nimport * as dom from '../dom';\nimport { isSessionClosedError } from '../protocolError';\n\nimport type { FFSession } from './ffConnection';\nimport type { Protocol } from './protocol';\n\nexport class FFExecutionContext implements js.ExecutionContextDelegate {\n  _session: FFSession;\n  _executionContextId: string;\n\n  constructor(session: FFSession, executionContextId: string) {\n    this._session = session;\n    this._executionContextId = executionContextId;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: true,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return payload.result!.value;\n  }\n\n  async rawEvaluateHandle(context: js.ExecutionContext, expression: string): Promise<js.JSHandle> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: false,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return createHandle(context, payload.result!);\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle, values: any[], handles: js.JSHandle[]): Promise<any> {\n    const payload = await this._session.send('Runtime.callFunction', {\n      functionDeclaration: expression,\n      args: [\n        { objectId: utilityScript._objectId, value: undefined },\n        ...values.map(value => ({ value })),\n        ...handles.map(handle => ({ objectId: handle._objectId!, value: undefined })),\n      ],\n      returnByValue,\n      executionContextId: this._executionContextId\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    if (returnByValue)\n      return parseEvaluationResultValue(payload.result!.value);\n    return createHandle(utilityScript._context, payload.result!);\n  }\n\n  async getProperties(object: js.JSHandle): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getObjectProperties', {\n      executionContextId: this._executionContextId,\n      objectId: object._objectId!,\n    });\n    const result = new Map();\n    for (const property of response.properties)\n      result.set(property.name, createHandle(object._context, property.value));\n    return result;\n  }\n\n  async releaseHandle(handle: js.JSHandle): Promise<void> {\n    if (!handle._objectId)\n      return;\n    await this._session.send('Runtime.disposeObject', {\n      executionContextId: this._executionContextId,\n      objectId: handle._objectId,\n    });\n  }\n}\n\nfunction checkException(exceptionDetails?: Protocol.Runtime.ExceptionDetails) {\n  if (!exceptionDetails)\n    return;\n  if (exceptionDetails.value)\n    throw new js.JavaScriptErrorInEvaluate(JSON.stringify(exceptionDetails.value));\n  else\n    throw new js.JavaScriptErrorInEvaluate(exceptionDetails.text + (exceptionDetails.stack ? '\\n' + exceptionDetails.stack : ''));\n}\n\nfunction rewriteError(error: Error): (Protocol.Runtime.evaluateReturnValue | Protocol.Runtime.callFunctionReturnValue) {\n  if (error.message.includes('cyclic object value') || error.message.includes('Object is not serializable'))\n    return { result: { type: 'undefined', value: undefined } };\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n  if (object.type === 'symbol')\n    return 'Symbol()';\n  if (object.subtype === 'regexp')\n    return 'RegExp';\n  if (object.subtype === 'weakmap')\n    return 'WeakMap';\n  if (object.subtype === 'weakset')\n    return 'WeakSet';\n  if (object.subtype)\n    return object.subtype[0].toUpperCase() + object.subtype.slice(1);\n  if ('value' in object)\n    return String(object.value);\n}\n\nexport function createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n  if (remoteObject.subtype === 'node') {\n    assert(context instanceof dom.FrameExecutionContext);\n    return new dom.ElementHandle(context, remoteObject.objectId!);\n  }\n  return new js.JSHandle(context, remoteObject.subtype || remoteObject.type || '', renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n}\n"],
  "mappings": "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",
  "names": []
}
